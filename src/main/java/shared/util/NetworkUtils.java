package shared.util;

import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.net.HttpURLConnection;
import java.net.InetAddress;
import java.net.InetSocketAddress;
import java.net.Socket;
import java.net.URL;
import java.net.UnknownHostException;
import java.util.logging.Level;
import java.util.logging.Logger;

/**
 * Utilit√°rios de rede para descobrir IPs e testar conectividade
 */
public class NetworkUtils {
    private static final Logger LOGGER = Logger.getLogger(NetworkUtils.class.getName());
    
    /**
     * Obt√©m o IP local da m√°quina (LAN)
     * 
     * @return IP local (ex: 192.168.1.100) ou "localhost"
     */
    public static String getLocalIP() {
        try {
            InetAddress localHost = InetAddress.getLocalHost();
            return localHost.getHostAddress();
        } catch (UnknownHostException e) {
            LOGGER.log(Level.WARNING, "Erro ao obter IP local", e);
            return "localhost";
        }
    }
    
    /**
     * Obt√©m o IP p√∫blico da m√°quina (Internet)
     * Faz requisi√ß√£o para servi√ßo externo
     * 
     * @return IP p√∫blico (ex: 177.45.123.89) ou null se falhar
     */
    public static String getPublicIP() {
        String[] services = {
            "https://api.ipify.org",
            "https://ifconfig.me/ip",
            "https://icanhazip.com"
        };
        
        for (String service : services) {
            try {
                URL url = new URL(service);
                HttpURLConnection conn = (HttpURLConnection) url.openConnection();
                conn.setRequestMethod("GET");
                conn.setConnectTimeout(3000);
                conn.setReadTimeout(3000);
                
                try (BufferedReader reader = new BufferedReader(
                        new InputStreamReader(conn.getInputStream()))) {
                    String ip = reader.readLine().trim();
                    if (isValidIP(ip)) {
                        LOGGER.log(Level.INFO, "IP p√∫blico detectado: {0}", ip);
                        return ip;
                    }
                }
            } catch (Exception e) {
                // Tenta pr√≥ximo servi√ßo
                LOGGER.log(Level.FINE, "Falha ao obter IP de " + service, e);
            }
        }
        
        LOGGER.warning("N√£o foi poss√≠vel obter IP p√∫blico");
        return null;
    }
    
    /**
     * Verifica se uma string √© um IP v√°lido
     */
    public static boolean isValidIP(String ip) {
        if (ip == null || ip.isEmpty()) {
            return false;
        }
        
        String[] parts = ip.split("\\.");
        if (parts.length != 4) {
            return false;
        }
        
        try {
            for (String part : parts) {
                int num = Integer.parseInt(part);
                if (num < 0 || num > 255) {
                    return false;
                }
            }
            return true;
        } catch (NumberFormatException e) {
            return false;
        }
    }
    
    /**
     * Verifica se um IP √© privado (LAN) ou p√∫blico (Internet)
     */
    public static boolean isPrivateIP(String ip) {
        if (!isValidIP(ip)) {
            return false;
        }
        
        // IPs privados (RFC 1918):
        // 10.0.0.0 - 10.255.255.255
        // 172.16.0.0 - 172.31.255.255
        // 192.168.0.0 - 192.168.255.255
        
        String[] parts = ip.split("\\.");
        int first = Integer.parseInt(parts[0]);
        int second = Integer.parseInt(parts[1]);
        
        if (first == 10) {
            return true;
        }
        if (first == 172 && second >= 16 && second <= 31) {
            return true;
        }
        if (first == 192 && second == 168) {
            return true;
        }
        if (ip.equals("127.0.0.1") || ip.equals("localhost")) {
            return true;
        }
        
        return false;
    }
    
    /**
     * Testa conectividade com um host
     * 
     * @param host IP ou hostname
     * @param port Porta
     * @param timeout Timeout em milissegundos
     * @return true se conseguiu conectar
     */
    public static boolean testConnection(String host, int port, int timeout) {
        try (Socket socket = new Socket()) {
            socket.connect(new InetSocketAddress(host, port), timeout);
            LOGGER.log(Level.INFO, "‚úÖ Conex√£o bem-sucedida com {0}:{1}", 
                new Object[]{host, port});
            return true;
        } catch (Exception e) {
            LOGGER.log(Level.WARNING, "‚ùå Falha ao conectar com {0}:{1}", 
                new Object[]{host, port});
            return false;
        }
    }
    
    /**
     * Retorna informa√ß√µes sobre a rede atual
     */
    public static String getNetworkInfo() {
        StringBuilder info = new StringBuilder();
        info.append("üì° Informa√ß√µes de Rede\n");
        info.append("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n");
        
        String localIP = getLocalIP();
        info.append("üè† IP Local (LAN): ").append(localIP).append("\n");
        
        if (isPrivateIP(localIP)) {
            info.append("   ‚îî‚îÄ Tipo: Rede Privada\n");
        }
        
        String publicIP = getPublicIP();
        if (publicIP != null) {
            info.append("üåê IP P√∫blico (Internet): ").append(publicIP).append("\n");
            info.append("   ‚îî‚îÄ Tipo: Acess√≠vel pela Internet\n");
        } else {
            info.append("üåê IP P√∫blico: N√£o dispon√≠vel\n");
        }
        
        info.append("\nüí° Dica:\n");
        if (localIP.equals(publicIP)) {
            info.append("   Seu servidor est√° diretamente conectado √† Internet!\n");
        } else {
            info.append("   Use IP Local para conex√µes na mesma rede (LAN)\n");
            info.append("   Use IP P√∫blico para conex√µes pela Internet\n");
            info.append("   (Requer Port Forwarding no roteador)\n");
        }
        
        return info.toString();
    }
    
    /**
     * Detecta automaticamente o melhor IP para usar
     * 
     * @param isLocalNetwork true se conectando na mesma rede
     * @return IP recomendado
     */
    public static String getRecommendedIP(boolean isLocalNetwork) {
        if (isLocalNetwork) {
            return getLocalIP();
        } else {
            String publicIP = getPublicIP();
            return publicIP != null ? publicIP : getLocalIP();
        }
    }
}
